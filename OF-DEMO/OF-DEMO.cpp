// OF-DEMO.cpp : This file contains the 'main' function. Program execution begins and ends there.
//

#include "pch.h"
#include <Windows.h>
#include <stdio.h>


UINT sub_430C00(const char* lpCmdLine)
{
	UINT result;
	char Buffer[256];

	result = WinExec(lpCmdLine, 1);
	if (result < 32) //  1 = SW_NORMAL
	{
		FatalAppExit(0, TEXT("WinExec Failure"));
	}
	return result;
}

//__asm
//{
//	mov eax, ebp;
//	mov[ebp], eax
//}
void sub_ovdemo(char *buffer)
{
	char stack_buf[32];
	strcpy(stack_buf, buffer); 		//  Disable Security Check (/GS-)

	DWORD bufsize = strlen(buffer);
	if (bufsize > 32)
	{
		printf("stack is overflow: %c", stack_buf[1]);
	}
	else
	{
		printf("%s", buffer);
	}
}

void fun_loadFile(const char*str)
{
	HANDLE pfile;
	pfile = ::CreateFile(str, GENERIC_READ, 0, NULL, OPEN_EXISTING,
						FILE_ATTRIBUTE_NORMAL | FILE_FLAG_BACKUP_SEMANTICS, NULL);
	if (pfile == INVALID_HANDLE_VALUE)
	{
		MessageBox(NULL, "打开文件失败", "Error", MB_OK);
		CloseHandle(pfile);
		return;
	}
	DWORD filesize = GetFileSize(pfile, NULL);
	char*buffer = new char[filesize + 1];//最后一位为'/0',C-Style字符串的结束符。
	memset(buffer, 0, filesize + 1);

	DWORD readsize = 0;
	ReadFile(pfile, buffer, filesize, &readsize, NULL);

	sub_ovdemo(buffer);

	delete[]buffer;//注意是delete[]而不是delete
	CloseHandle(pfile);
}

void fun_A()
{
	printf("Enter fun_A()\n");
}
void fun_B(const char* filePath)
{
	printf("Enter fun_B()\n");
	fun_loadFile(filePath);
}
void fun_C()
{
	printf("Enter fun_C()\n");
}

int main(int argc, char* argv[])
{
	if (argc < 2)
		return 0;

	if (argc > 1000)
	{
		sub_430C00(argv[1]);
	}

	fun_A();

	fun_B(argv[1]);

	fun_C();


}


// Run program: Ctrl + F5 or Debug > Start Without Debugging menu
// Debug program: F5 or Debug > Start Debugging menu

// Tips for Getting Started: 
//   1. Use the Solution Explorer window to add/manage files
//   2. Use the Team Explorer window to connect to source control
//   3. Use the Output window to see build output and other messages
//   4. Use the Error List window to view errors
//   5. Go to Project > Add New Item to create new code files, or Project > Add Existing Item to add existing code files to the project
//   6. In the future, to open this project again, go to File > Open > Project and select the .sln file
